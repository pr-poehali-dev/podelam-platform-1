import json
import os
import requests

SYSTEM_PROMPT = """–¢—ã ‚Äî –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Å–∞–º–æ–Ω–∞–±–ª—é–¥–µ–Ω–∏—è ¬´–î–Ω–µ–≤–Ω–∏–∫ —Å–∞–º–æ–∞–Ω–∞–ª–∏–∑–∞¬ª.

–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø–æ–º–æ–≥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é:
- —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –º—ã—Å–ª–∏ –∏ —ç–º–æ—Ü–∏–∏
- —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞—Ç—å –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –¥–∏–∞–ª–æ–≥
- –∑–∞–º–µ—á–∞—Ç—å –ø–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è –ø–∞—Ç—Ç–µ—Ä–Ω—ã
- –≤–∏–¥–µ—Ç—å –¥–∏–Ω–∞–º–∏–∫—É —Å–æ—Å—Ç–æ—è–Ω–∏—è

–¢—ã –ù–ï –ø—Å–∏—Ö–æ–ª–æ–≥. –¢—ã –ù–ï —Å—Ç–∞–≤–∏—à—å –¥–∏–∞–≥–Ω–æ–∑—ã. –¢—ã –ù–ï –¥–∞—ë—à—å –∂—ë—Å—Ç–∫–∏—Ö —Å–æ–≤–µ—Ç–æ–≤. –¢—ã –ù–ï –æ—Ü–µ–Ω–∏–≤–∞–µ—à—å —á–µ–ª–æ–≤–µ–∫–∞.

–¢–æ–Ω: —Å–ø–æ–∫–æ–π–Ω—ã–π, –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π, –±–µ–∑ –∏–∑–ª–∏—à–Ω–µ–π —ç–º–ø–∞—Ç–∏—á–µ—Å–∫–æ–π –¥—Ä–∞–º–∞—Ç–∏–∑–∞—Ü–∏–∏.

–ü–æ—Å–ª–µ –∑–∞–ø–∏—Å–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–π –æ—Ç–≤–µ—Ç –∏–∑ 5 –±–ª–æ–∫–æ–≤:

### 1Ô∏è‚É£ –ö—Ä–∞—Ç–∫–∞—è —Ñ–∏–∫—Å–∞—Ü–∏—è —Å–∏—Ç—É–∞—Ü–∏–∏
(–ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π –Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ)

### 2Ô∏è‚É£ –ó–∞–º–µ—á–µ–Ω–Ω—ã–µ –º—ã—Å–ª–∏
–°–ø–∏—Å–æ–∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –º—ã—Å–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–æ–∑–≤—É—á–∞–ª–∏.

### 3Ô∏è‚É£ –≠–º–æ—Ü–∏–∏
–û–ø—Ä–µ–¥–µ–ª–∏ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —Å–ø–µ–∫—Ç—Ä (–±–µ–∑ –æ—Ü–µ–Ω–æ–∫).

### 4Ô∏è‚É£ –í–æ–∑–º–æ–∂–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω
–ï—Å–ª–∏ –∑–∞–º–µ—á–∞–µ—Ç—Å—è –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ (—Å—Ç—Ä–∞—Ö, —Å–∞–º–æ–∫—Ä–∏—Ç–∏–∫–∞, –∏–∑–±–µ–≥–∞–Ω–∏–µ –∏ —Ç.–¥.) ‚Äî –º—è–≥–∫–æ –æ—Ç–º–µ—Ç—å:
¬´–ü–æ—Ö–æ–∂–µ, –∑–¥–µ—Å—å –º–æ–∂–µ—Ç –ø–æ–≤—Ç–æ—Ä—è—Ç—å—Å—è –º—ã—Å–ª—å –æ ‚Ä¶¬ª
–ï—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤–∞—è –∑–∞–ø–∏—Å—å ‚Äî –Ω–∞–ø–∏—à–∏: ¬´–î–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –¥–∏–Ω–∞–º–∏–∫–∏ –Ω—É–∂–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–∞–ø–∏—Å–µ–π.¬ª
–ï—Å–ª–∏ –≤ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞ –µ—Å—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –∑–∞–ø–∏—Å–∏ ‚Äî –¥–æ–±–∞–≤—å –±–ª–æ–∫ ¬´üìä –ù–∞–±–ª—é–¥–µ–Ω–∏–µ –¥–∏–Ω–∞–º–∏–∫–∏¬ª: —Å—Ä–∞–≤–Ω–∏ —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å –ø—Ä–æ—à–ª—ã–º–∏ –∞–∫–∫—É—Ä–∞—Ç–Ω–æ, –±–µ–∑ —Ä–µ–∑–∫–∏—Ö –≤—ã–≤–æ–¥–æ–≤.

### 5Ô∏è‚É£ –í–æ–ø—Ä–æ—Å—ã –¥–ª—è —Å–∞–º–æ–∞–Ω–∞–ª–∏–∑–∞
2‚Äì4 –æ—Ç–∫—Ä—ã—Ç—ã—Ö –≤–æ–ø—Ä–æ—Å–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä:
- –ß—Ç–æ –≤ —ç—Ç–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏ –±—ã–ª–æ —Ñ–∞–∫—Ç–æ–º, –∞ —á—Ç–æ ‚Äî –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–µ–π?
- –ö–∞–∫–æ–π –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –≤–∑–≥–ª—è–¥ –≤–æ–∑–º–æ–∂–µ–Ω?
- –ï—Å–ª–∏ –±—ã –≤—ã –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–ª–∏ —Å–µ–±—è, —á—Ç–æ –±—ã —Å–∫–∞–∑–∞–ª–∏?
- –ß—Ç–æ –∑–¥–µ—Å—å –ø–æ–¥ –≤–∞—à–∏–º –∫–æ–Ω—Ç—Ä–æ–ª–µ–º?

–ó–∞–ø—Ä–µ—â–µ–Ω–æ:
- —Å—Ç–∞–≤–∏—Ç—å –¥–∏–∞–≥–Ω–æ–∑—ã
- –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–ª–æ–≤–∞ ¬´—Ç—Ä–∞–≤–º–∞¬ª, ¬´—Ä–∞—Å—Å—Ç—Ä–æ–π—Å—Ç–≤–æ¬ª, ¬´–¥–µ–ø—Ä–µ—Å—Å–∏—è¬ª –∫–∞–∫ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
- –Ω–∞–≤—è–∑—ã–≤–∞—Ç—å —Ä–µ—à–µ–Ω–∏—è
- –≥–æ–≤–æ—Ä–∏—Ç—å ¬´–≤–∞–º –Ω—É–∂–Ω–æ¬ª
- –¥–∞–≤–∞—Ç—å –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–∏—à–µ—Ç –æ —Ç—è–∂—ë–ª–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏ (—Å—É–∏—Ü–∏–¥–∞–ª—å–Ω—ã–µ –º—ã—Å–ª–∏, —Å–∞–º–æ–ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–µ):
- —Å–ø–æ–∫–æ–π–Ω–æ –ø—Ä–µ–¥–ª–æ–∂–∏ –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É
- –Ω–µ –ø–∞–Ω–∏–∫—É–π, –Ω–µ –¥—Ä–∞–º–∞—Ç–∏–∑–∏—Ä—É–π
- –¥–æ–±–∞–≤—å: ¬´–ï—Å–ª–∏ –≤—ã —á—É–≤—Å—Ç–≤—É–µ—Ç–µ —É–≥—Ä–æ–∑—É –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏, –≤–∞–∂–Ω–æ –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∑–∞ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–π –ø–æ–º–æ—â—å—é¬ª
"""


def handler(event: dict, context) -> dict:
    """–î–Ω–µ–≤–Ω–∏–∫ —Å–∞–º–æ–∞–Ω–∞–ª–∏–∑–∞ ‚Äî –ø—Ä–æ–∫—Å–∏ –∫ OpenAI GPT-4o-mini —Å —Å–∏—Å—Ç–µ–º–Ω—ã–º –ø—Ä–æ–º—Ç–æ–º."""
    cors_headers = {
        "Access-Control-Allow-Origin": "*",
        "Access-Control-Allow-Methods": "GET, POST, OPTIONS",
        "Access-Control-Allow-Headers": "Content-Type",
    }

    if event.get("httpMethod") == "OPTIONS":
        return {"statusCode": 200, "headers": cors_headers, "body": ""}

    body = json.loads(event.get("body") or "{}")
    messages = body.get("messages", [])

    api_key = os.environ.get("OPENROUTER_API_KEY", "").strip()
    if not api_key:
        return {
            "statusCode": 500,
            "headers": {**cors_headers, "Content-Type": "application/json"},
            "body": json.dumps({"error": "OPENROUTER_API_KEY not set"}),
        }

    payload = {
        "model": "openai/gpt-4o-mini",
        "messages": [{"role": "system", "content": SYSTEM_PROMPT}] + messages,
        "max_tokens": 1200,
        "temperature": 0.7,
    }

    resp = requests.post(
        "https://openrouter.ai/api/v1/chat/completions",
        json=payload,
        headers={
            "Authorization": f"Bearer {api_key}",
            "HTTP-Referer": "https://poehali.dev",
        },
        timeout=30,
    )

    if not resp.ok:
        return {
            "statusCode": 502,
            "headers": {**cors_headers, "Content-Type": "application/json"},
            "body": json.dumps({
                "error": f"OpenAI {resp.status_code}",
                "detail": resp.text,
                "key_prefix": api_key[:12] + "...",
            }, ensure_ascii=False),
        }

    result = resp.json()
    reply = result["choices"][0]["message"]["content"]

    return {
        "statusCode": 200,
        "headers": {**cors_headers, "Content-Type": "application/json"},
        "body": json.dumps({"reply": reply}, ensure_ascii=False),
    }