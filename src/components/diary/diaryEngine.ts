export type Message = { id: number; from: "bot" | "user"; text: string; widget?: "finish_btn" };

export type DiaryEntry = {
  date: string;
  answers: { question: string; answer: string }[];
  emotion_tags: string[];
  intensity: number;
  supportText: string;
};

export type Phase = "intro" | "conversation" | "finishing" | "done";

function getUserEmail(): string {
  try { return JSON.parse(localStorage.getItem("pdd_user") || "{}").email || ""; } catch { return ""; }
}
export function CHAT_KEY() { return `diary_chat_${getUserEmail()}`; }
export function ENTRIES_KEY() { return `diary_entries_${getUserEmail()}`; }

const EMOTION_WORDS: Record<string, string[]> = {
  "—Ä–∞–¥–æ—Å—Ç—å": ["—Ä–∞–¥", "—Å—á–∞—Å—Ç–ª–∏–≤", "–∫–∞–π—Ñ", "–∫–ª–∞—Å—Å–Ω–æ", "–∫—Ä—É—Ç–æ", "—Å—É–ø–µ—Ä", "–≤–æ—Å—Ç–æ—Ä–≥", "–¥–æ–≤–æ–ª–µ–Ω", "—É–ª—ã–±–∫", "–≤–¥–æ—Ö–Ω–æ–≤", "—ç–Ω–µ—Ä–≥", "–ø–æ–¥—ä—ë–º", "–ª—ë–≥–∫", "—Å–≤–æ–±–æ–¥"],
  "—Ç—Ä–µ–≤–æ–≥–∞": ["—Ç—Ä–µ–≤–æ–∂", "–≤–æ–ª–Ω—É", "–±–µ—Å–ø–æ–∫–æ", "—Å—Ç—Ä–∞—à", "–Ω–µ—Ä–≤–Ω–∏—á", "–ø–∞–Ω–∏–∫", "–Ω–∞–ø—Ä—è–∂", "—Å—Ç—Ä–µ—Å—Å", "–ø–µ—Ä–µ–∂–∏–≤–∞–ª", "–±–æ—é—Å—å", "—Å—Ç—Ä–∞—Ö"],
  "–≥—Ä—É—Å—Ç—å": ["–≥—Ä—É—Å—Ç–Ω", "–ø–µ—á–∞–ª—å–Ω", "—Ç–æ—Å–∫", "–æ–¥–∏–Ω–æ—á", "–ø—É—Å—Ç", "—É–Ω—ã–Ω–∏", "—Å–ª—ë–∑", "–ø–ª–∞–∫", "–ø–æ—Ç–µ—Ä", "—Å–∫—É—á"],
  "–∑–ª–æ—Å—Ç—å": ["–∑–ª—é—Å—å", "–±–µ—Å–∏—Ç", "—Ä–∞–∑–¥—Ä–∞–∂", "–∑–ª–æ—Å—Ç—å", "–∞–≥—Ä–µ—Å—Å", "–Ω–µ–Ω–∞–≤–∏–∂", "–≤–æ–∑–º—É—â", "–Ω–µ—Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤", "–æ–±–∏–¥"],
  "—É—Å—Ç–∞–ª–æ—Å—Ç—å": ["—É—Å—Ç–∞–ª", "–≤—ã–º–æ—Ç–∞–Ω", "–≤—ã–≥–æ—Ä–µ–ª", "–±–µ–∑ —Å–∏–ª", "—Å–∏–ª –Ω–µ—Ç", "–∏—Å—Ç–æ—â—ë–Ω", "–ø–µ—Ä–µ–≥—Ä—É–∑", "—Ç—è–∂–µ–ª–æ"],
  "–≥–æ—Ä–¥–æ—Å—Ç—å": ["–≥–æ—Ä–∂—É—Å—å", "–¥–æ—Å—Ç–∏–∂", "–ø–æ–ª—É—á–∏–ª–æ—Å—å", "—Å–ø—Ä–∞–≤–∏–ª—Å—è", "—Å–¥–µ–ª–∞–ª", "–ø–æ–±–µ–¥–∏–ª", "—Ä–µ–∑—É–ª—å—Ç–∞—Ç", "—É—Å–ø–µ—Ö"],
  "—Å–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ": ["—Å–ø–æ–∫–æ–π–Ω", "—É–º–∏—Ä–æ—Ç–≤–æ—Ä", "—Ç–∏—Ö", "–≥–∞—Ä–º–æ–Ω–∏", "–±–∞–ª–∞–Ω—Å", "—Ä–∞—Å—Å–ª–∞–±", "—Ä–æ–≤–Ω"],
  "—Ä–∞—Å—Ç–µ—Ä—è–Ω–Ω–æ—Å—Ç—å": ["–Ω–µ –∑–Ω–∞—é", "–∑–∞–ø—É—Ç–∞–ª", "–Ω–µ –ø–æ–π–º", "–Ω–µ —É–≤–µ—Ä–µ–Ω", "—Å–æ–º–Ω–µ–≤–∞", "—Ç–µ—Ä—è—é—Å—å", "—Ä–∞–∑–≤–∏–ª–∫"],
  "–±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å": ["–±–ª–∞–≥–æ–¥–∞—Ä", "—Å–ø–∞—Å–∏–±–æ", "—Ü–µ–Ω—é", "–ø—Ä–∏–∑–Ω–∞—Ç–µ–ª", "–ø–æ–≤–µ–∑–ª–æ"],
  "–≤–∏–Ω–∞": ["–≤–∏–Ω–æ–≤–∞—Ç", "—Å—Ç—ã–¥–Ω", "–∂–∞–ª–µ", "–∫–æ—Ä—é —Å–µ–±—è", "–Ω–µ –¥–æ–ª–∂–µ–Ω –±—ã–ª", "–Ω–µ —Å—Ç–æ–∏–ª–æ"],
};

export function detectEmotions(texts: string[]): { tags: string[]; intensity: number } {
  const combined = texts.join(" ").toLowerCase();
  const found: string[] = [];
  let score = 0;

  for (const [emotion, words] of Object.entries(EMOTION_WORDS)) {
    for (const w of words) {
      if (combined.includes(w)) {
        if (!found.includes(emotion)) found.push(emotion);
        score++;
        break;
      }
    }
  }

  const intensity = Math.min(10, Math.max(1, Math.round(score * 2.5 + texts.reduce((a, t) => a + t.length, 0) / 200)));
  return { tags: found.length > 0 ? found : ["–Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ—Å—Ç—å"], intensity };
}

const OPENERS = [
  "–ü—Ä–∏–≤–µ—Ç! –ö–∞–∫ —Ç—ã —Å–µ–≥–æ–¥–Ω—è? –†–∞—Å—Å–∫–∞–∂–∏, —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ —Ç–≤–æ–µ–π –∂–∏–∑–Ω–∏ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å.",
  "–ü—Ä–∏–≤–µ—Ç! –†–∞–¥–∞ —Ç–µ–±—è –≤–∏–¥–µ—Ç—å. –° —á–µ–º —Ç—ã –ø—Ä–∏—à—ë–ª —Å–µ–≥–æ–¥–Ω—è? –ß—Ç–æ —É —Ç–µ–±—è –Ω–∞ –¥—É—à–µ?",
  "–ü—Ä–∏–≤–µ—Ç! –ö–∞–∫ –ø—Ä–æ—Ö–æ–¥–∏—Ç —Ç–≤–æ–π –¥–µ–Ω—å? –ü–æ–¥–µ–ª–∏—Å—å —Ç–µ–º, —á—Ç–æ —Ç–µ–±—è —Å–µ–π—á–∞—Å –∑–∞–Ω–∏–º–∞–µ—Ç.",
];

const DEEPENING_QUESTIONS: Record<string, string[]> = {
  "—Ä–∞–¥–æ—Å—Ç—å": [
    "–≠—Ç–æ –∑–¥–æ—Ä–æ–≤–æ! –ê —á—Ç–æ –∏–º–µ–Ω–Ω–æ –≤—ã–∑–≤–∞–ª–æ —ç—Ç–æ —á—É–≤—Å—Ç–≤–æ? –û–ø–∏—à–∏ –º–æ–º–µ–Ω—Ç –ø–æ–¥—Ä–æ–±–Ω–µ–µ.",
    "–ö–∞–∫ —Ç—ã –æ—â—É—â–∞–µ—à—å —ç—Ç—É —Ä–∞–¥–æ—Å—Ç—å –≤ —Ç–µ–ª–µ? –ì–¥–µ –æ–Ω–∞ –∂–∏–≤—ë—Ç?",
    "–ö–∞–∫ —Ç—ã –¥—É–º–∞–µ—à—å, —á—Ç–æ –ø–æ–º–æ–≥–ª–æ —ç—Ç–æ–º—É —Å–ª—É—á–∏—Ç—å—Å—è?",
  ],
  "—Ç—Ä–µ–≤–æ–≥–∞": [
    "–Ø —Å–ª—ã—à—É —Ç–µ–±—è. –ê –µ—Å–ª–∏ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç—å —Ç—Ä–µ–≤–æ–≥—É –∫–∞–∫ –ø—Ä–µ–¥–º–µ—Ç ‚Äî –∫–∞–∫–æ–π –±—ã –æ–Ω–∞ –±—ã–ª–∞? –ë–æ–ª—å—à–∞—è, –º–∞–ª–µ–Ω—å–∫–∞—è, –∫–∞–∫–æ–≥–æ —Ü–≤–µ—Ç–∞?",
    "–ß—Ç–æ —Å–∞–º–æ–µ —Ö—É–¥—à–µ–µ, —á—Ç–æ –º–æ–∂–µ—Ç —Å–ª—É—á–∏—Ç—å—Å—è? –ê –Ω–∞—Å–∫–æ–ª—å–∫–æ —ç—Ç–æ —Ä–µ–∞–ª—å–Ω–æ?",
    "–ß—Ç–æ –±—ã —Ç—ã —Å–∫–∞–∑–∞–ª –±–ª–∏–∑–∫–æ–º—É –¥—Ä—É–≥—É, –µ—Å–ª–∏ –±—ã –æ–Ω —á—É–≤—Å—Ç–≤–æ–≤–∞–ª —Ç–æ –∂–µ —Å–∞–º–æ–µ?",
  ],
  "–≥—Ä—É—Å—Ç—å": [
    "–°–ø–∞—Å–∏–±–æ, —á—Ç–æ –¥–µ–ª–∏—à—å—Å—è. –ë—ã–≤–∞–µ—Ç –ª–∏ —á—Ç–æ-—Ç–æ, —á—Ç–æ —Ö–æ—Ç—å –Ω–µ–º–Ω–æ–≥–æ —Å–æ–≥—Ä–µ–≤–∞–µ—Ç —Ç–µ–±—è —Å–µ–π—á–∞—Å?",
    "–ì—Ä—É—Å—Ç—å ‚Äî –≤–∞–∂–Ω–æ–µ —á—É–≤—Å—Ç–≤–æ. –û —á—ë–º –æ–Ω–∞ —Ç–µ–±–µ –≥–æ–≤–æ—Ä–∏—Ç?",
    "–ï—Å–ª–∏ –±—ã –≥—Ä—É—Å—Ç—å –º–æ–≥–ª–∞ –≥–æ–≤–æ—Ä–∏—Ç—å, —á—Ç–æ –±—ã –æ–Ω–∞ —Å–∫–∞–∑–∞–ª–∞ —Ç–µ–±–µ?",
  ],
  "–∑–ª–æ—Å—Ç—å": [
    "–ó–ª–æ—Å—Ç—å ‚Äî —ç—Ç–æ —ç–Ω–µ—Ä–≥–∏—è. –ù–∞ —á—Ç–æ –æ–Ω–∞ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∞? –ß—Ç–æ —Ç–µ–±–µ —Ö–æ—á–µ—Ç—Å—è –∏–∑–º–µ–Ω–∏—Ç—å?",
    "–ß—Ç–æ —Å—Ç–æ–∏—Ç –∑–∞ —ç—Ç–æ–π –∑–ª–æ—Å—Ç—å—é? –ò–Ω–æ–≥–¥–∞ –∑–∞ –Ω–µ–π –ø—Ä—è—á–µ—Ç—Å—è —á—Ç–æ-—Ç–æ –≤–∞–∂–Ω–æ–µ.",
    "–ï—Å–ª–∏ –±—ã —Ç—ã –º–æ–≥ —Å–µ–π—á–∞—Å –∏–∑–º–µ–Ω–∏—Ç—å –æ–¥–Ω—É –≤–µ—â—å –≤ —ç—Ç–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏ ‚Äî —á—Ç–æ –±—ã —ç—Ç–æ –±—ã–ª–æ?",
  ],
  "—É—Å—Ç–∞–ª–æ—Å—Ç—å": [
    "–ü–æ—Ö–æ–∂–µ, —Ç—ã –¥–∞–≤–Ω–æ –Ω–µ –æ—Ç–¥—ã—Ö–∞–ª –ø–æ-–Ω–∞—Å—Ç–æ—è—â–µ–º—É. –ö–æ–≥–¥–∞ —Ç—ã –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑ –¥–µ–ª–∞–ª —á—Ç–æ-—Ç–æ —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–µ–±—è?",
    "–ß—Ç–æ –∑–∞–±–∏—Ä–∞–µ—Ç –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ —ç–Ω–µ—Ä–≥–∏–∏ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å?",
    "–ï—Å–ª–∏ –±—ã –∑–∞–≤—Ç—Ä–∞ —Ç—ã –º–æ–≥ –ø—Ä–æ—Å–Ω—É—Ç—å—Å—è –æ—Ç–¥–æ—Ö–Ω—É–≤—à–∏–º ‚Äî —á—Ç–æ –±—ã –ø–µ—Ä–≤—ã–º –¥–µ–ª–æ–º —Å–¥–µ–ª–∞–ª?",
  ],
  "–≥–æ—Ä–¥–æ—Å—Ç—å": [
    "–¢—ã –∑–∞—Å–ª—É–∂–∏–≤–∞–µ—à—å —ç—Ç–æ–π –≥–æ—Ä–¥–æ—Å—Ç–∏. –ö–∞–∫–∏–µ —Å–≤–æ–∏ –∫–∞—á–µ—Å—Ç–≤–∞ —Ç—ã –∑–∞–¥–µ–π—Å—Ç–≤–æ–≤–∞–ª?",
    "–ö–æ–º—É –±—ã —Ç—ã —Ö–æ—Ç–µ–ª —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å –æ–± —ç—Ç–æ–º?",
    "–ö–∞–∫ —Ç—ã –º–æ–∂–µ—à—å –æ–ø–∏—Ä–∞—Ç—å—Å—è –Ω–∞ —ç—Ç–æ—Ç –æ–ø—ã—Ç –≤ –±—É–¥—É—â–µ–º?",
  ],
  "—Ä–∞—Å—Ç–µ—Ä—è–Ω–Ω–æ—Å—Ç—å": [
    "–ù–µ–æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ—Å—Ç—å ‚Äî —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ. –ê —á—Ç–æ –ø–æ–¥—Å–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–µ–±–µ –∏–Ω—Ç—É–∏—Ü–∏—è?",
    "–ï—Å–ª–∏ –±—ã —Ç–µ–±–µ –Ω–µ –Ω—É–∂–Ω–æ –±—ã–ª–æ –Ω–∏—á–µ–≥–æ —Ä–µ—à–∞—Ç—å –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å ‚Äî —á—Ç–æ –±—ã —Ç—ã —á—É–≤—Å—Ç–≤–æ–≤–∞–ª?",
    "–ö–∞–∫–æ–π –≤–∞—Ä–∏–∞–Ω—Ç –≤—ã–∑—ã–≤–∞–µ—Ç –±–æ–ª—å—à–µ —ç–Ω–µ—Ä–≥–∏–∏, –¥–∞–∂–µ –µ—Å–ª–∏ –∫–∞–∂–µ—Ç—Å—è —Å—Ç—Ä–∞—à–Ω—ã–º?",
  ],
  "–≤–∏–Ω–∞": [
    "–¢—ã –æ—á–µ–Ω—å —Å—Ç—Ä–æ–≥ –∫ —Å–µ–±–µ. –ê —á—Ç–æ –±—ã —Å–∫–∞–∑–∞–ª —Ç–≤–æ–π –¥–æ–±—Ä—ã–π –¥—Ä—É–≥, –µ—Å–ª–∏ –±—ã —É—Å–ª—ã—à–∞–ª —ç—Ç–æ?",
    "–ß—Ç–æ —Ç—ã –º–æ–∂–µ—à—å —Å–¥–µ–ª–∞—Ç—å –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å, —á—Ç–æ–±—ã –Ω–µ–º–Ω–æ–≥–æ –æ—Ç–ø—É—Å—Ç–∏—Ç—å —ç—Ç–æ —á—É–≤—Å—Ç–≤–æ?",
    "–ò–Ω–æ–≥–¥–∞ –≤–∏–Ω–∞ ‚Äî —ç—Ç–æ –∑–Ω–∞–∫, —á—Ç–æ —Ç–µ–±–µ —á—Ç–æ-—Ç–æ –≤–∞–∂–Ω–æ. –ß—Ç–æ –∏–º–µ–Ω–Ω–æ —Ç–µ–±–µ –≤–∞–∂–Ω–æ –∑–¥–µ—Å—å?",
  ],
  "default": [
    "–†–∞—Å—Å–∫–∞–∂–∏ –ø–æ–¥—Ä–æ–±–Ω–µ–µ ‚Äî —á—Ç–æ —Ç—ã —á—É–≤—Å—Ç–≤—É–µ—à—å –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å, –≤ —ç—Ç—É —Å–µ–∫—É–Ω–¥—É?",
    "–ê —á—Ç–æ —Å—Ç–æ–∏—Ç –∑–∞ —ç—Ç–∏–º? –ú–æ–∂–µ—Ç –±—ã—Ç—å, –µ—Å—Ç—å —á—Ç–æ-—Ç–æ, —á—Ç–æ —Ç—ã –µ—â—ë –Ω–µ –æ–∑–≤—É—á–∏–ª?",
    "–ü—Ä–µ–¥—Å—Ç–∞–≤—å, —á—Ç–æ –ø—Ä–æ—à—ë–ª –º–µ—Å—è—Ü. –ö–∞–∫ —Ç—ã –±—É–¥–µ—à—å –≤—Å–ø–æ–º–∏–Ω–∞—Ç—å —ç—Ç–æ—Ç –º–æ–º–µ–Ω—Ç?",
    "–ï—Å–ª–∏ –±—ã –∫—Ç–æ-—Ç–æ –±–ª–∏–∑–∫–∏–π –±—ã–ª —Ä—è–¥–æ–º ‚Äî —á—Ç–æ –±—ã —Ç—ã –µ–º—É —Å–∫–∞–∑–∞–ª?",
    "–ß—Ç–æ –¥–ª—è —Ç–µ–±—è —Å–µ–π—á–∞—Å –±—ã–ª–æ –±—ã –∏–¥–µ–∞–ª—å–Ω—ã–º –∏—Å—Ö–æ–¥–æ–º?",
    "–ß—Ç–æ —Ç–µ–±—è –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤ —Ç–∞–∫–∏–µ –º–æ–º–µ–Ω—Ç—ã? –ù–∞ —á—Ç–æ —Ç—ã –æ–ø–∏—Ä–∞–µ—à—å—Å—è?",
    "–ï—Å—Ç—å –ª–∏ —á—Ç–æ-—Ç–æ –µ—â—ë, —á—Ç–æ —Ö–æ—á–µ—Ç—Å—è –¥–æ–±–∞–≤–∏—Ç—å? –ò–Ω–æ–≥–¥–∞ –≤–∞–∂–Ω–æ–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç –≤ –∫–æ–Ω—Ü–µ.",
  ],
};

const TRANSITION_PHRASES = [
  "–°–ø–∞—Å–∏–±–æ, —á—Ç–æ –ø–æ–¥–µ–ª–∏–ª—Å—è.",
  "–Ø —Ç–µ–±—è —Å–ª—ã—à—É.",
  "–≠—Ç–æ –≤–∞–∂–Ω–æ ‚Äî —Ç–æ, —á—Ç–æ —Ç—ã –≥–æ–≤–æ—Ä–∏—à—å.",
  "–°–ø–∞—Å–∏–±–æ –∑–∞ —á–µ—Å—Ç–Ω–æ—Å—Ç—å.",
  "–ü–æ–Ω–∏–º–∞—é —Ç–µ–±—è.",
];

export function getOpener(): string {
  return OPENERS[Math.floor(Math.random() * OPENERS.length)];
}

export function getNextQuestion(answers: { question: string; answer: string }[], questionIndex: number): string | null {
  if (questionIndex >= 7) return null;

  const allAnswerText = answers.map(a => a.answer);
  const { tags } = detectEmotions(allAnswerText);
  const mainEmotion = tags[0] || "default";

  const pool = DEEPENING_QUESTIONS[mainEmotion] || DEEPENING_QUESTIONS["default"];
  const defaultPool = DEEPENING_QUESTIONS["default"];
  const combined = [...pool, ...defaultPool];

  const usedQuestions = new Set(answers.map(a => a.question));
  const available = combined.filter(q => !usedQuestions.has(q));

  if (available.length === 0) return null;

  const transition = TRANSITION_PHRASES[Math.floor(Math.random() * TRANSITION_PHRASES.length)];

  const question = available[Math.floor(Math.random() * Math.min(3, available.length))];
  return `${transition} ${question}`;
}

const SUPPORT_POSITIVE = [
  "–¢—ã —É–º–µ–µ—à—å –∑–∞–º–µ—á–∞—Ç—å —Ö–æ—Ä–æ—à–µ–µ ‚Äî —ç—Ç–æ —Å–∏–ª—å–Ω–∞—è —Å—Ç–æ—Ä–æ–Ω–∞. –î–µ—Ä–∂–∏ —ç—Ç–æ—Ç –Ω–∞—Å—Ç—Ä–æ–π.",
  "–†–∞–¥–æ—Å—Ç—å, –∫–æ—Ç–æ—Ä—É—é —Ç—ã –æ–ø–∏—Å—ã–≤–∞–µ—à—å ‚Äî –∑–∞—Å–ª—É–∂–µ–Ω–Ω–∞—è. –¢—ã –ø—Ä–æ–¥–µ–ª–∞–ª –ø—É—Ç—å, —á—Ç–æ–±—ã –±—ã—Ç—å –∑–¥–µ—Å—å.",
  "–û—Ç–ª–∏—á–Ω—ã–π –¥–µ–Ω—å. –ó–∞–ø–æ–º–Ω–∏ —ç—Ç–æ –æ—â—É—â–µ–Ω–∏–µ ‚Äî –æ–Ω–æ –ø–æ–º–æ–∂–µ—Ç –≤ —Ç—Ä—É–¥–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã.",
];

const SUPPORT_TOUGH = [
  "–¢–æ, —á—Ç–æ —Ç—ã –ø—Ä–∏—à—ë–ª —Å—é–¥–∞ –∏ –Ω–∞–ø–∏—Å–∞–ª –æ–± —ç—Ç–æ–º ‚Äî —É–∂–µ —à–∞–≥. –¢—ã –Ω–µ –æ–¥–∏–Ω.",
  "–°–ª–æ–∂–Ω—ã–µ —á—É–≤—Å—Ç–≤–∞ –Ω–µ –∑–Ω–∞—á–∏—Ç, —á—Ç–æ —Ç—ã —Å–ª–∞–±—ã–π. –≠—Ç–æ –∑–Ω–∞—á–∏—Ç, —á—Ç–æ —Ç–µ–±–µ –Ω–µ –≤—Å—ë —Ä–∞–≤–Ω–æ.",
  "–ü–æ–º–Ω–∏: –∑–∞ –∫–∞–∂–¥–æ–π —Ç—è–∂—ë–ª–æ–π –ø–æ–ª–æ—Å–æ–π —Å–ª–µ–¥—É–µ—Ç –ø–æ–¥—ä—ë–º. –¢—ã —Å–ø—Ä–∞–≤–∏—à—å—Å—è.",
  "–¢—ã –∑–∞—Å–ª—É–∂–∏–≤–∞–µ—à—å –ø–æ–¥–¥–µ—Ä–∂–∫–∏. –ï—Å–ª–∏ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —Å–ª–∏—à–∫–æ–º —Ç—è–∂–µ–ª–æ ‚Äî –ø–æ–≥–æ–≤–æ—Ä–∏ —Å –∫–µ–º-—Ç–æ –±–ª–∏–∑–∫–∏–º.",
];

const SUPPORT_NEUTRAL = [
  "–¢—ã —É—á–∏—à—å—Å—è –ª—É—á—à–µ –ø–æ–Ω–∏–º–∞—Ç—å —Å–µ–±—è ‚Äî –∞ —ç—Ç–æ —É–∂–µ –±–æ–ª—å—à–æ–π —à–∞–≥.",
  "–ö–∞–∂–¥–∞—è –∑–∞–ø–∏—Å—å ‚Äî –∫–∏—Ä–ø–∏—á–∏–∫ —Å–∞–º–æ–ø–æ–∑–Ω–∞–Ω–∏—è. –í–æ–∑–≤—Ä–∞—â–∞–π—Å—è, –∫–æ–≥–¥–∞ –∑–∞—Ö–æ—á–µ—à—å.",
  "–†–µ–≥—É–ª—è—Ä–Ω–æ–µ –Ω–∞–±–ª—é–¥–µ–Ω–∏–µ –∑–∞ —Å–æ–±–æ–π ‚Äî –ø—Ä–∏–≤—ã—á–∫–∞, –∫–æ—Ç–æ—Ä–∞—è –º–µ–Ω—è–µ—Ç –∂–∏–∑–Ω—å.",
];

export function buildSupport(answers: { question: string; answer: string }[]): string {
  const allText = answers.map(a => a.answer);
  const { tags, intensity } = detectEmotions(allText);

  const positive = ["—Ä–∞–¥–æ—Å—Ç—å", "–≥–æ—Ä–¥–æ—Å—Ç—å", "–±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å", "—Å–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ"];
  const tough = ["—Ç—Ä–µ–≤–æ–≥–∞", "–≥—Ä—É—Å—Ç—å", "–∑–ª–æ—Å—Ç—å", "—É—Å—Ç–∞–ª–æ—Å—Ç—å", "–≤–∏–Ω–∞"];

  const isPositive = tags.some(t => positive.includes(t));
  const isTough = tags.some(t => tough.includes(t));

  const lines: string[] = [];

  lines.push("üìù **–ó–∞–ø–∏—Å—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞**\n");

  if (tags.length > 0 && tags[0] !== "–Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ—Å—Ç—å") {
    lines.push(`–≠–º–æ—Ü–∏–∏ —Å–µ–≥–æ–¥–Ω—è: ${tags.map(t => `**${t}**`).join(", ")}`);
    lines.push(`–ì–ª—É–±–∏–Ω–∞ –ø—Ä–æ—Ä–∞–±–æ—Ç–∫–∏: ${intensity}/10\n`);
  }

  if (answers.length >= 4) {
    lines.push("–¢—ã —Å–µ–≥–æ–¥–Ω—è –≥–ª—É–±–æ–∫–æ –∫–æ–ø–Ω—É–ª ‚Äî —ç—Ç–æ —Ü–µ–Ω–Ω–æ.\n");
  } else if (answers.length >= 2) {
    lines.push("–î–∞–∂–µ –∫–æ—Ä–æ—Ç–∫–∞—è –∑–∞–ø–∏—Å—å –∏–º–µ–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ.\n");
  }

  lines.push("---\n");
  lines.push("üí¨ **–°–ª–æ–≤–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏**\n");

  const pool = isPositive ? SUPPORT_POSITIVE : isTough ? SUPPORT_TOUGH : SUPPORT_NEUTRAL;
  lines.push(pool[Math.floor(Math.random() * pool.length)]);

  if (isTough && isPositive) {
    lines.push("\n–¢—ã –≤–∏–¥–∏—à—å –∏ —Å–≤–µ—Ç–ª—ã–µ, –∏ —Ç—ë–º–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã ‚Äî —ç—Ç–æ –∑—Ä–µ–ª–æ—Å—Ç—å.");
  }

  lines.push("\n–î–æ –≤—Å—Ç—Ä–µ—á–∏ –≤ —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–∑. –¢—ã –º–æ–ª–æ–¥–µ—Ü, —á—Ç–æ —É–¥–µ–ª–∏–ª —Å–µ–±–µ –≤—Ä–µ–º—è.");

  return lines.join("\n");
}
